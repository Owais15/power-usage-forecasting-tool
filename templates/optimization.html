{% extends "base.html" %}

{% block title %}Optimization - Power Usage Forecasting Tool{% endblock %}

{% block extra_css %}
<style>
    .suggestion-card {
        transition: transform 0.2s;
    }
    .suggestion-card:hover {
        transform: translateY(-2px);
    }
    .impact-high { border-left: 4px solid #ef4444; }
    .impact-medium { border-left: 4px solid #f59e0b; }
    .impact-low { border-left: 4px solid #10b981; }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
    <div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
            <i class="fas fa-lightbulb text-yellow-600 mr-3"></i>
            Power Usage Optimization
        </h1>
        <p class="text-gray-600">Smart suggestions to reduce energy consumption and costs</p>
    </div>
    <button class="btn btn-outline-primary mt-4 sm:mt-0" onclick="refreshOptimization()">
        <i class="fas fa-sync-alt mr-2"></i>
        Refresh Analysis
    </button>
</div>

<!-- Cost Analysis Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Current Cost -->
    <div class="card hover-lift">
        <div class="p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-dollar-sign text-red-600 text-xl"></i>
                    </div>
                </div>
                <div class="ml-4 flex-1">
                    <p class="text-sm font-medium text-gray-600 mb-1">Current Cost</p>
                    <p class="text-2xl font-bold text-gray-900">${{ "%.2f"|format(current_cost) }}</p>
                    <p class="text-sm text-red-600 flex items-center">
                        <i class="fas fa-arrow-up mr-1"></i>
                        Current Period
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Optimized Cost -->
    <div class="card hover-lift">
        <div class="p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-chart-line text-green-600 text-xl"></i>
                    </div>
                </div>
                <div class="ml-4 flex-1">
                    <p class="text-sm font-medium text-gray-600 mb-1">Optimized Cost</p>
                    <p class="text-2xl font-bold text-gray-900">${{ "%.2f"|format(optimized_cost) }}</p>
                    <p class="text-sm text-green-600 flex items-center">
                        <i class="fas fa-arrow-down mr-1"></i>
                        With Optimizations
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Potential Savings -->
    <div class="card hover-lift">
        <div class="p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-piggy-bank text-yellow-600 text-xl"></i>
                    </div>
                </div>
                <div class="ml-4 flex-1">
                    <p class="text-sm font-medium text-gray-600 mb-1">Potential Savings</p>
                    <p class="text-2xl font-bold text-gray-900">${{ "%.2f"|format(potential_savings) }}</p>
                    <p class="text-sm text-yellow-600 flex items-center">
                        <i class="fas fa-percentage mr-1"></i>
                        {{ "%.1f"|format((potential_savings / current_cost * 100) if current_cost > 0 else 0) }}% savings
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Suggestions Count -->
    <div class="card hover-lift">
        <div class="p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-lightbulb text-blue-600 text-xl"></i>
                    </div>
                </div>
                <div class="ml-4 flex-1">
                    <p class="text-sm font-medium text-gray-600 mb-1">Suggestions</p>
                    <p class="text-2xl font-bold text-gray-900">{{ suggestions|length }}</p>
                    <p class="text-sm text-blue-600 flex items-center">
                        <i class="fas fa-list mr-1"></i>
                        Available optimizations
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Optimization Suggestions -->
<div class="card mb-8">
    <div class="card-header">
        <h5 class="card-title">
            <i class="fas fa-list-check text-blue-600 mr-2"></i>
            Optimization Suggestions
        </h5>
    </div>
    <div class="card-body">
        {% if suggestions %}
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {% for suggestion in suggestions %}
                <div class="card suggestion-card hover-lift impact-{{ suggestion.impact }}">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <h6 class="text-lg font-semibold text-gray-900">{{ suggestion.title }}</h6>
                            <span class="px-3 py-1 text-xs font-semibold rounded-full 
                                {% if suggestion.impact == 'high' %}bg-red-100 text-red-800
                                {% elif suggestion.impact == 'medium' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-green-100 text-green-800{% endif %}">
                                {{ suggestion.impact|title }}
                            </span>
                        </div>
                        <p class="text-gray-600 mb-4">{{ suggestion.description }}</p>
                        
                        {% if suggestion.actions %}
                        <div class="mb-4">
                            <h6 class="text-blue-600 font-semibold mb-2">Recommended Actions:</h6>
                            <ul class="space-y-1">
                                {% for action in suggestion.actions %}
                                <li class="flex items-center text-sm text-gray-700">
                                    <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                    {{ action }}
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        
                        <div class="flex justify-between items-center">
                            <span class="text-green-600 font-semibold">
                                <i class="fas fa-dollar-sign mr-1"></i>
                                Potential Savings: ${{ "%.2f"|format(suggestion.potential_savings) }}
                            </span>
                            <button class="btn btn-outline-primary btn-sm" onclick="implementSuggestion('{{ suggestion.type }}')">
                                <i class="fas fa-play mr-1"></i>
                                Implement
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-12">
                <i class="fas fa-check-circle text-green-600 mb-4" style="font-size: 3rem;"></i>
                <h5 class="text-xl font-semibold text-gray-900 mb-2">Great Job!</h5>
                <p class="text-gray-600">No optimization suggestions found. Your power usage is already well optimized!</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Usage Patterns Analysis -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Peak Usage Analysis -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title">
                <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
                Peak Usage Analysis
            </h5>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="peakUsageChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Cost Breakdown -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title">
                <i class="fas fa-pie-chart text-green-600 mr-2"></i>
                Cost Breakdown
            </h5>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="costBreakdownChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Implementation Progress -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title">
            <i class="fas fa-tasks text-purple-600 mr-2"></i>
            Implementation Progress
        </h5>
    </div>
    <div class="card-body">
        <div class="space-y-4">
            {% for suggestion in suggestions[:3] %}
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                        <i class="fas fa-lightbulb text-blue-600"></i>
                    </div>
                    <div>
                        <h6 class="font-semibold text-gray-900">{{ suggestion.title }}</h6>
                        <p class="text-sm text-gray-600">Potential savings: ${{ "%.2f"|format(suggestion.potential_savings) }}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-32 bg-gray-200 rounded-full h-2 overflow-hidden">
                        <div class="bg-blue-600 h-2 rounded-full" style="width: {{ ((loop.index0 + 1) / 3 * 100) | round(0, 'floor') }}%;"></div>
                    </div>
                    <span class="text-sm text-gray-600">{{ ((loop.index0 + 1) / 3 * 100) | round(0, 'floor') }}%</span>
                </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Parse optimization data from Flask
const optimizationData = JSON.parse('{{ optimization_data | tojson | safe }}');

// Peak Usage Chart
const peakUsageCtx = document.getElementById('peakUsageChart').getContext('2d');
const peakUsageChart = new Chart(peakUsageCtx, {
    type: 'bar',
    data: {
        labels: optimizationData.peak_hours || ['6AM', '9AM', '12PM', '3PM', '6PM', '9PM'],
        datasets: [{
            label: 'Current Usage',
            data: optimizationData.current_usage || [2.1, 3.2, 2.8, 3.5, 4.2, 3.8],
            backgroundColor: '#ef4444',
            borderColor: '#dc2626',
            borderWidth: 1
        }, {
            label: 'Optimized Usage',
            data: optimizationData.optimized_usage || [1.8, 2.9, 2.5, 3.1, 3.7, 3.3],
            backgroundColor: '#10b981',
            borderColor: '#059669',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Power Usage (kWh)'
                }
            }
        },
        plugins: {
            legend: {
                position: 'top',
            }
        }
    }
});

// Cost Breakdown Chart
const costBreakdownCtx = document.getElementById('costBreakdownChart').getContext('2d');
const costBreakdownChart = new Chart(costBreakdownCtx, {
    type: 'doughnut',
    data: {
        labels: ['Heating/Cooling', 'Lighting', 'Appliances', 'Electronics', 'Other'],
        datasets: [{
            data: [35, 20, 25, 15, 5],
            backgroundColor: [
                '#ef4444',
                '#f59e0b',
                '#3b82f6',
                '#10b981',
                '#8b5cf6'
            ],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
            }
        }
    }
});

// Implement suggestion function
function implementSuggestion(type) {
    fetch('/api/implement_suggestion', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ type: type })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Suggestion implemented successfully!');
            location.reload();
        } else {
            alert('Error implementing suggestion: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error implementing suggestion');
    });
}

// Refresh optimization function
function refreshOptimization() {
    location.reload();
}
</script>
{% endblock %} 