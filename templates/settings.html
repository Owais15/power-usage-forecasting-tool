{% extends "base.html" %}

{% block title %}Settings - Power Usage Forecasting Tool{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Settings</h1>

    <!-- Electricity Preferences -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <div class="flex items-center mb-4">
            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white mr-3">
                <i class="fas fa-bolt"></i>
            </div>
            <div>
                <h2 class="text-xl font-semibold text-gray-900">Electricity Preferences</h2>
                <p class="text-gray-600">Configure your electricity rates and usage preferences</p>
            </div>
        </div>

        <form method="POST" action="{{ url_for('update_settings') }}">
            <div class="mb-4">
                <label for="electricity_rate" class="block text-sm font-medium text-gray-700 mb-2">
                    Electricity Rate (per kWh)
                </label>
                <input type="number" 
                       id="electricity_rate" 
                       name="electricity_rate" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                       step="0.01" 
                       min="0" 
                       value="{{ settings.get('electricity_rate', '0.12') }}"
                       required>
                <p class="text-sm text-gray-500 mt-1">Enter your current electricity rate to calculate costs accurately</p>
            </div>

            <div class="mb-4">
                <label for="peak_hours" class="block text-sm font-medium text-gray-700 mb-2">
                    Peak Hours
                </label>
                <input type="text" 
                       id="peak_hours" 
                       name="peak_hours" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                       value="{{ settings.get('peak_hours', '18:00-22:00') }}"
                       placeholder="e.g., 18:00-22:00">
                <p class="text-sm text-gray-500 mt-1">Define your peak electricity usage hours for better optimization</p>
            </div>

            <div class="mb-4">
                <label for="high_usage_threshold" class="block text-sm font-medium text-gray-700 mb-2">
                    High Usage Threshold (kW)
                </label>
                <input type="number" 
                       id="high_usage_threshold" 
                       name="high_usage_threshold" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                       step="0.1" 
                       min="0" 
                       value="{{ settings.get('high_usage_threshold', '4.0') }}">
                <p class="text-sm text-gray-500 mt-1">Set threshold for high usage alerts</p>
            </div>

            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" 
                           name="green_energy" 
                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                           {{ 'checked' if settings.get('green_energy') == 'True' else '' }}>
                    <span class="ml-2 text-sm font-medium text-gray-700">Green Energy Focus</span>
                </label>
                <p class="text-sm text-gray-500 mt-1">Prioritize energy-saving recommendations</p>
            </div>

            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                <i class="fas fa-save mr-2"></i>
                Save Preferences
            </button>
        </form>
    </div>

    <!-- Notification Settings -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <div class="flex items-center mb-4">
            <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white mr-3">
                <i class="fas fa-bell"></i>
            </div>
            <div>
                <h2 class="text-xl font-semibold text-gray-900">Notifications</h2>
                <p class="text-gray-600">Configure how you want to be notified about your power usage</p>
            </div>
        </div>

        <form method="POST" action="{{ url_for('update_settings') }}">
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" 
                           name="notifications" 
                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                           {{ 'checked' if settings.get('notifications') == 'True' else '' }}>
                    <span class="ml-2 text-sm font-medium text-gray-700">Enable Notifications</span>
                </label>
                <p class="text-sm text-gray-500 mt-1">Receive alerts for high usage and optimization suggestions</p>
            </div>

            <div class="mb-4">
                <label for="alert_frequency" class="block text-sm font-medium text-gray-700 mb-2">
                    Alert Frequency
                </label>
                <select name="alert_frequency" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="daily" {{ 'selected' if settings.get('alert_frequency') == 'daily' else '' }}>Daily</option>
                    <option value="weekly" {{ 'selected' if settings.get('alert_frequency') == 'weekly' else '' }}>Weekly</option>
                    <option value="monthly" {{ 'selected' if settings.get('alert_frequency') == 'monthly' else '' }}>Monthly</option>
                </select>
                <p class="text-sm text-gray-500 mt-1">How often you want to receive usage reports</p>
            </div>

            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                <i class="fas fa-save mr-2"></i>
                Save Notification Settings
            </button>
        </form>
    </div>

    <!-- Data Management -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <div class="flex items-center mb-4">
            <div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center text-white mr-3">
                <i class="fas fa-database"></i>
            </div>
            <div>
                <h2 class="text-xl font-semibold text-gray-900">Data Management</h2>
                <p class="text-gray-600">Manage your power usage data and exports</p>
            </div>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Export Data</label>
            <p class="text-sm text-gray-500 mb-3">Download your power usage data for analysis</p>
            <button onclick="exportData()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                <i class="fas fa-download mr-2"></i>
                Export CSV
            </button>
        </div>

        <div class="mb-4">
            <label for="data_retention" class="block text-sm font-medium text-gray-700 mb-2">Data Retention</label>
            <select id="data_retention" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="updateDataRetention()">
                <option value="30">30 days</option>
                <option value="90">90 days</option>
                <option value="365">1 year</option>
                <option value="0">Keep all data</option>
            </select>
            <p class="text-sm text-gray-500 mt-1">How long to keep your historical data</p>
            <button type="button" onclick="updateDataRetention()" class="mt-2 bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700 transition-colors">
                Apply Retention Policy
            </button>
        </div>
    </div>

    <!-- Danger Zone -->
    <div class="bg-red-50 border-2 border-red-200 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-red-800 mb-4">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            Danger Zone
        </h3>
        <p class="text-red-700 mb-4">These actions cannot be undone. Please be careful.</p>
        
        <div class="mb-4">
            <button onclick="clearUserData()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors mr-2">
                <i class="fas fa-trash mr-2"></i>
                Clear All My Data
            </button>
            <button onclick="deleteAccount()" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                <i class="fas fa-user-times mr-2"></i>
                Delete Account
            </button>
        </div>
        
        <p class="text-sm text-red-600">
            <i class="fas fa-info-circle mr-1"></i>
            Clearing data will remove all your power usage records, forecasts, and settings.
        </p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function exportData() {
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 30);
        
        const endDate = new Date();
        
        const url = `/api/export_data?start_date=${startDate.toISOString().split('T')[0]}&end_date=${endDate.toISOString().split('T')[0]}`;
        
        fetch(url)
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `power_usage_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            })
            .catch(error => {
                console.error('Error exporting data:', error);
                alert('Error exporting data. Please try again.');
            });
    }

    function clearUserData() {
        if (confirm('Are you sure you want to clear all your data? This action cannot be undone.')) {
            fetch('/api/clear_user_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('All data cleared successfully.');
                    location.reload();
                } else {
                    alert('Error clearing data: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error clearing data. Please try again.');
            });
        }
    }

    function deleteAccount() {
        if (confirm('Are you sure you want to delete your account? This action cannot be undone and will permanently remove all your data.')) {
            if (confirm('This is your final warning. All your data will be permanently deleted. Are you absolutely sure?')) {
                fetch('/api/delete_account', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Account deleted successfully.');
                        window.location.href = '/';
                    } else {
                        alert('Error deleting account: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting account. Please try again.');
                });
            }
        }
    }

    function updateDataRetention() {
        const retentionDays = document.getElementById('data_retention').value;
        const message = retentionDays == 0 ? 
            'This will keep all your data. Continue?' : 
            `This will remove data older than ${retentionDays} days. Continue?`;
        
        if (confirm(message)) {
            fetch('/api/update_data_retention', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    retention_days: parseInt(retentionDays)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                } else {
                    alert('Error updating data retention: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating data retention. Please try again.');
            });
        }
    }
</script>
{% endblock %}
